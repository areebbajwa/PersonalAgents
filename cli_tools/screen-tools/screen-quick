#!/bin/bash
# Quick screen - start a screen session named after the current directory
# This preserves the working directory properly

# Get the current directory name
if [[ "$PWD" == "$HOME" ]]; then
    DIR_NAME="home"
else
    DIR_NAME=$(basename "$PWD")
fi

# Clean the directory name (remove special chars, truncate if too long)
CLEAN_DIR=$(echo "$DIR_NAME" | sed 's/[^a-zA-Z0-9_-]/-/g' | cut -c1-30)

# If we ended up with empty or just dash, use "quick"
if [[ -z "$CLEAN_DIR" || "$CLEAN_DIR" == "-" ]]; then
    CLEAN_DIR="quick"
fi

echo "ðŸ“º Starting quick screen session '${CLEAN_DIR}' in $(pwd)"

# Start screen with current directory preserved
# Add logging to debug issues
STARTUP_DIR="$PWD"
LOG_FILE="/tmp/screen-quick-${CLEAN_DIR}.log"

echo "Starting quick screen session: ${CLEAN_DIR}" > "$LOG_FILE"
echo "Current directory: $STARTUP_DIR" >> "$LOG_FILE"
echo "Shell: $SHELL" >> "$LOG_FILE"
echo "Date: $(date)" >> "$LOG_FILE"

# Create a wrapper script that logs and changes directory
WRAPPER_SCRIPT="/tmp/screen-wrapper-${CLEAN_DIR}.sh"
cat > "$WRAPPER_SCRIPT" << EOF
#!/bin/bash
echo "Wrapper script starting..." >> "$LOG_FILE"
echo "Initial PWD: \$PWD" >> "$LOG_FILE"
cd "$STARTUP_DIR" || echo "CD failed: \$?" >> "$LOG_FILE"
echo "After CD PWD: \$PWD" >> "$LOG_FILE"
exec $SHELL -l
EOF
chmod +x "$WRAPPER_SCRIPT"

echo "Starting screen with wrapper script..." >> "$LOG_FILE"
exec screen -S "${CLEAN_DIR}" "$WRAPPER_SCRIPT"
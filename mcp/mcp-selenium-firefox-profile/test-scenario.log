Testing user scenario: Multiple Claude Code sessions sharing Firefox...
1. Simulating first Claude Code session starting selenium MCP...
Server1 stderr: Creating new Firefox instance...

Server1 stderr: Found default Firefox profile: /Users/areeb2/Library/Application Support/Firefox/Profiles/1nykysv3.default-release

Server1 stderr: Using Firefox profile: /Users/areeb2/Library/Application Support/Firefox/Profiles/1nykysv3.default-release

Server1 stderr: Setting up port detection timeout...

Server1 stderr: Browser started with session_id: firefox_1750797744211

Server1 stderr: Port detection timeout triggered, detecting port...

Server1 stderr: Detected geckodriver HTTP port from process: 65402

Server1 stderr: Port detection result: 65402

Server1 stderr: WebDriver proxy started on port 9515, forwarding to geckodriver on 65402

Server1 stderr: Saved geckodriver port 65402 and proxy port 9515 to coordination file

First server response: {"result":{"content":[{"type":"text","text":"Browser started with session_id: firefox_1750797744211"}]},"jsonrpc":"2.0","id":1}

✓ Coordination file created: {
  hasBrowser: true,
  port: 65402,
  proxyPort: 9515,
  lastActivity: 1750797746400
}
✓ Proxy server started on port 9515
2. Simulating second Claude Code session connecting...
Server2 stderr: Attempting to connect via proxy...

Server2 stderr: Using existing Firefox instance via proxy - no new WebDriver session needed
Connected via proxy with session_id: firefox_proxy_1750797749474

Second server response: {"result":{"content":[{"type":"text","text":"Connected via proxy with session_id: firefox_proxy_1750797749474"}]},"jsonrpc":"2.0","id":1}

✓ First instance started browser successfully
✓ Second instance connected via proxy
✓ User scenario test completed
Summary:
- First instance should create Firefox and proxy
- Second instance should detect existing instance and connect via proxy
- Both instances should be able to control the same Firefox browser
Server2 stderr: Error closing browser during cleanup: TypeError: state.driver.quit is not a function
    at process.cleanup (file:///Volumes/ExtremeSSD/PersonalAgents/PersonalAgents/mcp/mcp-selenium-firefox-profile/server.js:892:32)
    at process.emit (node:events:518:28)

Server1 stderr: Browser closed during cleanup

Server1 stderr: Proxy server closed during cleanup


=== TEST RESULTS ===
First instance worked: ✓
Second instance used proxy: ✓
Coordination file created: ✓

✓ Core functionality working - proxy infrastructure ready
